<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forschungstauchgang Planer</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f0f8ff;
        }
        #map {
            height: 400px;
            margin-bottom: 20px;
            border-radius: 8px;
        }
        .container {
            max-width: 800px;
            margin: auto;
        }
        label, input, textarea {
            display: block;
            width: 100%;
            margin-bottom: 10px;
        }
        .section {
            margin-bottom: 20px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        button {
            background-color: #005b8f;
            color: white;
            cursor: pointer;
            padding: 10px;
            border: none;
            border-radius: 4px;
            width: 100%;
            margin-top: 10px;
        }
        button:hover {
            background-color: #003d66;
        }
        #marine-life-result, #weather-info, #marine-data-result, #luftverbrauch-result {
            display: none;
            margin-top: 20px;
            padding: 15px;
            background-color: #e0f7fa;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Forschungstauchgang Planer</h1>

        <!-- Karte -->
        <div id="map" class="section"></div>

        <!-- Lat/Lon Inputs für den Marker -->
        <div class="section">
            <label for="latitude">Breitengrad (Latitude):</label>
            <input type="number" id="latitude" step="0.0001">
            <label for="longitude">Längengrad (Longitude):</label>
            <input type="number" id="longitude" step="0.0001">
        </div>

        <!-- Wetter berechnen -->
        <div class="section">
            <h2>2. Wetter berechnen</h2>
            <button type="button" onclick="berechneWetter()">Wetter berechnen</button>
            <div id="weather-result"></div>
        </div>

        <!-- Tauchausrüstung Checkliste -->
        <div class="section">
            <h2>Tauchausrüstung Checkliste</h2>
            <ul id="equipment-list">
                <li><input type="checkbox"> Maske</li>
                <li><input type="checkbox"> Flossen</li>
                <li><input type="checkbox"> Neoprenanzug</li>
                <li><input type="checkbox"> Tauchcomputer</li>
                <li><input type="checkbox"> Atemregler</li>
            </ul>
        </div>

        <!-- Wasserlebewesen -->
        <div class="section">
            <h2>Wasserlebewesen im Umkreis von 500m</h2>
            <button onclick="zeigeWasserlebewesen()">Wasserlebewesen anzeigen</button>
            <div id="marine-life-result"></div>
        </div>

        <!-- Strömung & Wellen -->
        <div class="section">
            <h2>Strömung und Wellenhöhe</h2>
            <button onclick="berechneStrömungWellen()">Strömung und Wellenhöhen abrufen</button>
            <div id="marine-data-result"></div>
        </div>

        <!-- Luftverbrauch -->
        <div class="section">
            <h2>Luftverbrauch berechnen</h2>
            <label for="tauchgang-tiefe">Tauchgang Tiefe (m):</label>
            <input type="number" id="tauchgang-tiefe">
            <label for="tauchgang-dauer">Dauer des Tauchgangs (min):</label>
            <input type="number" id="tauchgang-dauer">
            <label for="luftverbrauch-pro-minute">Luftverbrauch pro Minute (L):</label>
            <input type="number" id="luftverbrauch-pro-minute">
            <button type="button" onclick="berechneLuftverbrauch()">Luftverbrauch berechnen</button>
            <div id="luftverbrauch-result"></div>
        </div>

        <!-- PDF Bericht -->
        <div class="section">
            <h2>PDF-Bericht</h2>
            <button onclick="generatePDF()">PDF erstellen</button>
        </div>
    </div>

    <script>
        const apiKey = '4db9283324a61d252299927649bb85a6';
        let map, marker;

        document.addEventListener('DOMContentLoaded', initializeMap);

        function initializeMap() {
            map = L.map('map').setView([51.1657, 10.4515], 6);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);

            map.on('click', function (e) {
                const { lat, lng } = e.latlng;
                document.getElementById('latitude').value = lat;
                document.getElementById('longitude').value = lng;

                // Markierung auf der Karte hinzufügen
                if (marker) {
                    map.removeLayer(marker);
                }
                marker = L.marker([lat, lng]).addTo(map);
            });
        }

        async function berechneWetter() {
            const lat = document.getElementById('latitude').value || 51.1657;
            const lon = document.getElementById('longitude').value || 10.4515;

            try {
                const response = await fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=${apiKey}&units=metric&lang=de`);
                if (!response.ok) throw new Error('Fehler beim Abrufen der Wetterdaten');
                const data = await response.json();

                const weatherInfo = `
                    <h3>Wetterdaten</h3>
                    <p>Temperatur: ${data.main.temp}°C</p>
                    <p>Wetter: ${data.weather[0].description}</p>
                    <p>Wind: ${data.wind.speed} m/s</p>
                `;

                document.getElementById('weather-result').style.display = 'block';
                document.getElementById('weather-result').innerHTML = weatherInfo;
            } catch (error) {
                document.getElementById('weather-result').style.display = 'block';
                document.getElementById('weather-result').innerHTML = `Fehler: ${error.message}`;
            }
        }

        async function zeigeWasserlebewesen() {
            const lat = parseFloat(document.getElementById('latitude').value);
            const lon = parseFloat(document.getElementById('longitude').value);

            if (!lat || !lon) {
                alert('Bitte wählen Sie einen Ort auf der Karte aus.');
                return;
            }

            try {
                const response = await fetch(`https://api.obis.org/v3/occurrence?decimalLatitude=${lat}&decimalLongitude=${lon}&radius=0.5`);
                if (!response.ok) throw new Error('Fehler beim Abrufen der Wasserlebewesen-Daten.');
                const data = await response.json();

                if (data.results && data.results.length > 0) {
                    const speciesList = data.results.map(result => result.vernacularName || result.scientificName).join(", ");
                    document.getElementById('marine-life-result').style.display = 'block';
                    document.getElementById('marine-life-result').innerHTML = `Wasserlebewesen im Umkreis von 500 Metern: ${speciesList}`;
                } else {
                    document.getElementById('marine-life-result').style.display = 'block';
                    document.getElementById('marine-life-result').innerHTML = 'Keine Wasserlebewesen im Umkreis gefunden.';
                }
            } catch (error) {
                alert(`Fehler: ${error.message}`);
            }
        }

        async function berechneStrömungWellen() {
            const lat = parseFloat(document.getElementById('latitude').value);
            const lon = parseFloat(document.getElementById('longitude').value);

            if (!lat || !lon) {
                alert('Bitte wählen Sie einen Ort auf der Karte aus.');
                return;
            }

            try {
                const response = await fetch(`https://marine-api.open-meteo.com/v1/marine?latitude=${lat}&longitude=${lon}&hourly=wave_height&daily=wave_height_max`);
                if (!response.ok) throw new Error('Fehler beim Abrufen der Strömungs- und Wellenhöhen-Daten.');

                const data = await response.json();
                const maxWaveHeight = data.daily?.wave_height_max?.[0] || 'Nicht verfügbar';
                const hourlyWaveHeights = data.hourly?.wave_height?.slice(0, 5) || [];

                const waveHeightsString = hourlyWaveHeights.length
                    ? hourlyWaveHeights.map(height => `${height} m`).join(', ')
                    : 'Keine Daten verfügbar';

                document.getElementById('marine-data-result').style.display = 'block';
                document.getElementById('marine-data-result').innerHTML = `
                    <h3>Strömung & Wellenhöhe</h3>
                    <p>Maximale Wellenhöhe: ${maxWaveHeight} m</p>
                    <p>Wellenhöhen in den nächsten Stunden: ${waveHeightsString}</p>
                `;
            } catch (error) {
                alert(`Fehler: ${error.message}`);
            }
        }

        function berechneLuftverbrauch() {
            const tiefe = parseFloat(document.getElementById('tauchgang-tiefe').value);
            const dauer = parseFloat(document.getElementById('tauchgang-dauer').value);
            const verbrauchProMinute = parseFloat(document.getElementById('luftverbrauch-pro-minute').value);

            if (!tiefe || !dauer || !verbrauchProMinute) {
                alert('Bitte füllen Sie alle Felder aus.');
                return;
            }

            const luftverbrauch = verbrauchProMinute * dauer; // In Litern
            document.getElementById('luftverbrauch-result').style.display = 'block';
            document.getElementById('luftverbrauch-result').innerHTML = `Luftverbrauch: ${luftverbrauch} L`;
        }

        function generatePDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            let yPosition = 20; // Startposition für den Text

            // Titel hinzufügen
            doc.setFontSize(22);
            doc.setFont('helvetica', 'bold');
            doc.text('Forschungstauchgang Bericht', 20, yPosition);

            // Abstand nach dem Titel
            yPosition += 40;  // Abstand nach dem Titel

            // Wetterdaten
            doc.setFontSize(16);
            doc.setTextColor(0, 102, 204);  // Blaue Farbe für Überschrift
            doc.setFont('helvetica', 'bold');
            doc.text('Wetter & Umweltbedingungen:', 20, yPosition);
            yPosition += 10; // Abstand nach Überschrift
            doc.setTextColor(0, 0, 0); // Schwarz für den Text
            doc.setFontSize(12);
            doc.setFont('helvetica', 'normal');
            const weatherText = document.getElementById('weather-result').innerText || 'Keine Wetterdaten verfügbar';
            doc.text(weatherText, 20, yPosition);
            
            // Abstand nach Wetterdaten
            yPosition += 50;  // Abstand für die nächste Sektion

            // Wasserlebewesen
            doc.setFontSize(16);
            doc.setTextColor(0, 102, 204); // Blaue Farbe für Überschrift
            doc.setFont('helvetica', 'bold');
            doc.text('Wasserlebewesen im Umkreis von 500m:', 20, yPosition);
            yPosition += 10; // Abstand nach Überschrift
            doc.setTextColor(0, 0, 0); // Schwarz für den Text
            doc.setFontSize(12);
            doc.setFont('helvetica', 'normal');
            const marineLifeText = document.getElementById('marine-life-result').innerText || 'Keine Wasserlebewesen im Umkreis gefunden.';
            doc.text(marineLifeText, 20, yPosition);

            // Abstand nach Wasserlebewesen
            yPosition += 40;  // Abstand für die nächste Sektion

            // Strömung & Wellenhöhe
            doc.setFontSize(16);
            doc.setTextColor(0, 102, 204); // Blaue Farbe für Überschrift
            doc.setFont('helvetica', 'bold');
            doc.text('Strömung und Wellenhöhe:', 20, yPosition);
            yPosition += 10; // Abstand nach Überschrift
            doc.setTextColor(0, 0, 0); // Schwarz für den Text
            doc.setFontSize(12);
            doc.setFont('helvetica', 'normal');
            const marineDataText = document.getElementById('marine-data-result').innerText || 'Keine Daten verfügbar';
            doc.text(marineDataText, 20, yPosition);

            // Abstand nach Strömung & Wellenhöhe
            yPosition += 50;  // Abstand für die nächste Sektion

            // Luftverbrauch
            doc.setFontSize(16);
            doc.setTextColor(0, 102, 204); // Blaue Farbe für Überschrift
            doc.setFont('helvetica', 'bold');
            doc.text('Luftverbrauch:', 20, yPosition);
            yPosition += 10; // Abstand nach Überschrift
            doc.setTextColor(0, 0, 0); // Schwarz für den Text
            doc.setFontSize(12);
            doc.setFont('helvetica', 'normal');
            const airConsumptionText = document.getElementById('luftverbrauch-result').innerText || 'Keine Berechnung durchgeführt.';
            doc.text(airConsumptionText, 20, yPosition);

            // Abstand nach Luftverbrauch
            yPosition += 40;  // Abstand für die nächste Sektion

            // Abschließender Hinweis oder Text
            doc.setFontSize(10);
            doc.setFont('helvetica', 'italic');
            doc.text('Alle Angaben sind basierend auf den aktuellsten verfügbaren Daten.', 20, yPosition);

            // PDF speichern
            doc.save('tauchgang_bericht.pdf');
        }
    </script>
</body>
</html>
